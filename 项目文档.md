# PasteMine 项目文档

## 项目概述

PasteMine 是一个功能强大的 macOS 剪贴板历史管理应用，使用 SwiftUI 构建，采用现代化的 "Liquid Glass" 视觉设计风格。应用以菜单栏工具的形式运行，能够监控剪贴板变化、存储历史记录（文本和图片），并通过全局快捷键提供快速访问和自动粘贴功能。

**核心特性：**
- 📋 自动监控并保存剪贴板历史（文本和图片）
- ⚡️ 全局快捷键快速调出历史窗口（默认 ⌘⇧V）
- 🎯 自动粘贴功能，一键即可粘贴历史记录
- 📌 支持固定常用剪贴板项目
- 🔍 强大的搜索和过滤功能
- 🎨 精美的 Liquid Glass 设计风格
- 🔔 可选的通知和音效反馈

---

## 目录结构

```
PasteMine/PasteMine/
├── App/                                    # 应用程序生命周期
│   └── AppDelegate.swift                   # 应用代理和启动逻辑
│
├── Models/                                 # 数据模型
│   ├── ClipboardItem.swift                 # 剪贴板项目 Core Data 实体
│   ├── Settings.swift                      # 应用设置模型
│   └── KeyboardShortcut.swift              # 快捷键配置
│
├── Services/                               # 业务服务层
│   ├── ClipboardMonitor.swift              # 剪贴板监控服务
│   ├── DatabaseService.swift               # Core Data 数据库服务
│   ├── PasteService.swift                  # 粘贴操作服务
│   ├── NotificationService.swift           # 系统通知服务
│   ├── SoundService.swift                  # 音效播放服务
│   └── LaunchAtLoginService.swift          # 开机启动服务
│
├── Managers/                               # 管理器
│   ├── WindowManager.swift                 # 窗口管理器（显示/隐藏/定位）
│   └── HotKeyManager.swift                 # 全局快捷键管理器
│
├── Utilities/                              # 工具类
│   ├── ImageStorageManager.swift           # 图片文件存储管理
│   ├── HashUtility.swift                   # SHA-256 哈希工具（去重）
│   └── Extensions.swift                    # NSApplication 扩展
│
├── Views/                                  # 视图组件
│   ├── MainWindow/                         # 主窗口视图
│   │   ├── HistoryListView.swift           # 历史列表视图（带搜索）
│   │   ├── HistoryItemView.swift           # 单个历史项目视图
│   │   └── SearchBarView.swift             # 搜索栏组件
│   ├── Settings/                           # 设置界面
│   │   └── SettingsView.swift              # 设置面板
│   ├── Onboarding/                         # 引导流程
│   │   └── OnboardingView.swift            # 首次启动引导向导
│   └── Components/                         # 可复用组件
│       ├── EmptyStateView.swift            # 空状态占位图
│       └── ShortcutRecorderView.swift      # 快捷键录制器
│
├── Extensions/                             # 扩展
│   └── ColorExtensions.swift               # Liquid Glass 设计配色和动画
│
├── Resources/                              # 资源文件
│   └── Sounds/                             # 音效文件
│       ├── 3.wav                           # 复制音效
│       └── 4.wav                           # 粘贴音效
│
├── PasteMine.xcdatamodeld/                 # Core Data 模型定义
├── Assets.xcassets/                        # 应用图标和资源
├── PasteMineApp.swift                      # 应用入口
├── ContentView.swift                       # 根视图
├── Info.plist                              # 应用配置
└── PasteMine.entitlements                  # 安全权限配置
```

---

## 核心功能详解

### 1. 剪贴板监控 (ClipboardMonitor.swift)

**文件位置：** `Services/ClipboardMonitor.swift`

**工作原理：**
- 使用 Timer 每 0.5 秒轮询系统剪贴板
- 通过 `NSPasteboard.changeCount` 检测变化
- 支持格式：文本（`.string`）、图片（`.png`, `.tiff`, `.pdf`）
- 使用 SHA-256 哈希进行去重，避免重复记录
- 智能粘贴检测：通过 `isPasting` 标志避免在粘贴时重复保存
- 记录来源应用程序名称

**数据流程：**
```
用户复制内容
    ↓
检测剪贴板变化 (checkClipboard)
    ↓
处理文本/图片 (handleText/handleImage)
    ↓
计算 SHA-256 哈希
    ↓
检查是否重复 (hashExists)
    ↓
保存到数据库 (DatabaseService)
    ↓
发送通知 + 播放音效
```

**关键代码位置：**
- 主检测逻辑：第 50-79 行
- 文本处理：第 82-101 行
- 图片处理：第 104-148 行

---

### 2. 数据存储 (DatabaseService.swift)

**文件位置：** `Services/DatabaseService.swift`

**存储架构：**
- **框架：** Core Data + NSPersistentContainer
- **数据模型：** ClipboardItem 实体
- **存储路径：** `~/Library/Containers/com.lemonstyle.PasteMine/Data/Library/Application Support/PasteMine/`
- **自动合并：** 启用 `automaticallyMergesChangesFromParent`

**核心方法：**

| 方法 | 功能 | 行数 |
|------|------|------|
| `insertTextItem()` | 保存文本项（基于哈希去重） | 36-58 |
| `insertImageItemRawData()` | 保存图片（保留原始质量） | 61-87 |
| `trimToLimit()` | 根据设置自动清理旧记录 | 166-186 |
| `clearAll()` | 清空所有历史记录和关联图片 | 147-163 |

**去重策略：**
1. 计算内容的 SHA-256 哈希值
2. 插入前检查 `hashExists()` 方法
3. 哈希值存储在 `contentHash` 字段中

---

### 3. 图片存储 (ImageStorageManager.swift)

**文件位置：** `Utilities/ImageStorageManager.swift`

**存储策略：**
- **存储目录：** `~/Library/Containers/com.lemonstyle.PasteMine/Data/Library/Application Support/PasteMine/images/`
- **文件命名：** `{SHA256哈希}.{扩展名}` （如 `a1b2c3...png`）
- **支持格式：** PNG、TIFF、PDF（保留原始格式）
- **质量保证：** 存储原始数据，保持原始质量

**大图片限制功能（第 35-42 行）：**
- **设置项：** `ignoreLargeImages` 开关
- **阈值：** 20 MB
- **行为：** 启用时自动跳过超过 20MB 的图片

**关键方法：**
- `saveImageRawData()` - 保存图片并返回路径、哈希、尺寸等信息
- `deleteImage()` - 删除单个图片文件
- `clearAllImages()` - 删除所有图片
- `cleanOrphanedImages()` - 清理未被引用的孤立图片

---

### 4. 自动粘贴服务 (PasteService.swift)

**文件位置：** `Services/PasteService.swift`

**粘贴流程：**

1. **复制到剪贴板**（第 28-50 行）
   - 文本：使用 `.string` 类型
   - 图片：使用原始数据和原始格式

2. **隐藏窗口**（第 53 行）
   - 关闭历史记录窗口

3. **激活前一个应用**（第 56-69 行）
   - 返回焦点到打开 PasteMine 之前的应用

4. **模拟 Cmd+V**（第 97-118 行）
   - 使用 `CGEvent` 发送键盘事件
   - 需要辅助功能权限

5. **发送通知**（第 121-134 行）
   - 显示粘贴确认提示

6. **防止重复保存**（第 136-141 行）
   - 设置 `clipboardMonitor.isPasting = true`
   - 等待 0.6 秒（比监控间隔 0.5 秒长）
   - 防止粘贴操作被再次记录

**辅助功能权限降级策略：**
- `simulatePaste()` 在检测到未授予辅助功能权限时，仅复制内容，不再模拟 Cmd+V
- 会触发「权限提醒」通知，并在主窗口顶部显示 Banner，指引用户前往系统设置开启

**权限要求：**
- 需要辅助功能权限才能模拟键盘输入
- 在 `Extensions.swift` 第 13 行检查权限

---

### 5. 窗口管理 (WindowManager.swift)

**文件位置：** `Managers/WindowManager.swift`

**窗口配置（第 22-52 行）：**
```swift
窗口属性：
├── 尺寸：400×600（默认）
├── 样式：标题栏、可关闭、可调整大小、全尺寸内容
├── 层级：浮动窗口（始终置顶）
├── 背景：超薄材质效果（macOS 14+）
└── 行为：可加入所有空间、辅助全屏
```

**智能定位算法（第 107-143 行）：**
- 跟随鼠标光标位置
- **优先级：** 光标右侧 → 光标左侧 → 光标居中
- **边距：** 距离光标 20pt
- **边界检查：** 确保窗口完全在屏幕内

**点击外部关闭功能（第 145-197 行）：**
- 全局鼠标事件监听器
- 检测点击位置是否在窗口外
- 自动隐藏窗口

**滚动到顶部功能（第 69-72 行）：**
- 显示窗口时发送 `.scrollToTop` 通知
- 延迟 0.1 秒让视图先渲染
- 在 `HistoryListView` 第 118 行实现

---

### 6. 全局快捷键系统 (HotKeyManager.swift)

**文件位置：** `Managers/HotKeyManager.swift`

**技术实现：**
- **API：** Carbon Event Manager (`RegisterEventHotKey`)
- **优势：** 无需"输入监控"权限（相比 CGEvent 监听器）
- **默认快捷键：** ⌘⇧V（Cmd+Shift+V）

**注册流程（第 33-95 行）：**
```swift
1. 从 AppSettings 加载快捷键配置
2. 创建 EventHotKeyID（签名：'PSTM'，ID：1）
3. 安装事件处理器回调
4. 注册快捷键及其修饰键和键码
5. 监听 .shortcutDidChange 通知
```

**动态更新（第 110-116 行）：**
- 观察 `NotificationCenter` 的 `.shortcutDidChange` 事件
- 设置更改时自动重新注册
- 注册新快捷键前先注销旧的

---

## 数据模型

### ClipboardItem (Core Data 实体)

**文件位置：** `Models/ClipboardItem.swift`

**属性定义：**

```swift
@NSManaged 属性：
├── id: UUID                    // 唯一标识符
├── content: String?            // 文本内容（图片为 nil）
├── contentHash: String?        // SHA-256 哈希（用于去重）
├── createdAt: Date?            // 创建时间戳
├── appSource: String?          // 来源应用程序名称
├── type: String                // "text" 或 "image"
├── imagePath: String?          // 图片文件路径
├── imageWidth: Int32           // 图片宽度
├── imageHeight: Int32          // 图片高度
├── isPinned: Bool              // 是否已固定（新功能）
└── pinnedAt: Date?             // 固定时间戳（新功能）
```

**计算属性：**
- `itemType` - 类型枚举转换
- `imageFormat` - 图片文件扩展名（如 "png"）
- `pasteboardType` - 用于粘贴的 NSPasteboard 类型
- `imageRawData` - 从文件加载原始图片数据
- `image` - NSImage 用于显示
- `displayText` - 用户友好的文本/尺寸描述

**最近新增功能（来自 Git 历史）：**
- 提交 `0f9debf` 添加了固定/取消固定功能
- 允许用户"收藏"剪贴板项目
- 固定的项目显示在列表顶部

---

### AppSettings (应用设置)

**文件位置：** `Models/Settings.swift`

```swift
struct AppSettings: Codable {
    var notificationEnabled: Bool = true        // 启用通知
    var soundEnabled: Bool = true               // 启用音效
    var launchAtLogin: Bool = false             // 开机启动
    var globalShortcut: KeyboardShortcut        // 全局快捷键（⌘⇧V）
    var maxHistoryCount: Int = 50               // 历史记录上限（50/200/999）
    var ignoreLargeImages: Bool = false         // 忽略大图片（新功能）
    var clipboardHistoryEnabled: Bool = false   // 用户同意后才开始记录
}
```

**存储方式：** UserDefaults（JSON 编码）
**存储键：** "app_settings"

**最近更改：**
1. 默认新增 `clipboardHistoryEnabled` 开关：首次启动需在引导页勾选后才会开启后台监控，可在设置-通用中随时停用。
2. `ignoredApps` 预置常见密码管理器（1Password、钥匙串、KeePassX 等），`ignoreTypesEnabled` 默认开启，防止敏感类型被记录。
3. `ignoreLargeImages` 保持 20MB 限制，仍可在设置-存储中切换。

---

### KeyboardShortcut (快捷键配置)

**文件位置：** `Models/KeyboardShortcut.swift`

**结构定义：**
```swift
struct KeyboardShortcut: Codable, Equatable {
    var keyCode: UInt16        // 虚拟键码（如 kVK_ANSI_V）
    var modifiers: UInt32      // 修饰键标志（cmdKey, shiftKey 等）
}
```

**显示转换（第 23-44 行）：**
- 将修饰键标志转换为符号：⌃⌥⇧⌘
- 将键码映射为可读字符串（A-Z、0-9、方向键、F 键等）
- 示例：`keyCode=9, modifiers=cmdKey|shiftKey` → "⌘⇧V"

**验证（第 111-115 行）：**
- 要求至少一个修饰键
- 防止纯字符快捷键（如只有 "V"）

---

## 用户界面组件

### 1. 主窗口视图 (HistoryListView)

**文件位置：** `Views/MainWindow/HistoryListView.swift`

**核心功能：**
- 显示分页的剪贴板项目列表
- 搜索/过滤功能
- 键盘导航（↑↓ 方向键、回车键）
- 右键菜单（固定/取消固定、删除）
- 底部操作栏（清空全部、设置）
- 当系统未授予辅助功能权限时，在搜索栏下方显示提醒 Banner，说明自动粘贴将降级为仅复制并提供跳转按钮

**搜索逻辑（第 28-64 行）：**
```swift
文本项目：localizedCaseInsensitiveContains(searchText)
图片项目：搜索 appSource 或关键词 "图片"/"image"
```

**固定/排序优先级（第 50-63 行）：**
```
排序顺序：
1. 已固定项目（按 pinnedAt 降序）
2. 未固定项目（按 createdAt 降序）
```

**键盘快捷键：**
- **↓（键码 125）：** 向下移动选择
- **↑（键码 126）：** 向上移动选择
- **回车（键码 36）：** 粘贴选中项目

**右键菜单（第 95-102 行）：**
- **固定/取消固定：** 切换 `isPinned` 状态
- **删除：** 从数据库移除项目

**清空全部确认（第 210-262 行）：**
- NSAlert 模态对话框
- "确定要清空所有历史记录吗？" 警告
- 在后台线程执行删除
- 立即隐藏窗口以提升用户体验

---

### 2. 历史项目视图 (HistoryItemView)

**文件位置：** `Views/MainWindow/HistoryItemView.swift`

**布局设计：**
```
┌──────────────────────────────────────────┐
│ [图片缩略图]  文本预览           📌      │
│              2分钟前 · Chrome            │
└──────────────────────────────────────────┘
```

**视觉状态：**
- **悬停：** 材质背景 + 阴影（第 106-130 行）
- **选中：** 更强的材质效果 + 径向渐变
- **已固定：** 蓝色边框（1.5pt，30% 不透明度）（第 133-136 行）

**图片显示（第 38-59 行）：**
- 缩略图：80×80pt，圆角 8pt
- 加载失败时显示占位图
- 悬停时阴影效果增强

**固定按钮（第 90-100 行）：**
- 悬停或已固定时显示
- 激活时蓝色，未激活时次要颜色
- 使用表情符号：📌

**Liquid Glass 设计（macOS 14+）：**
- `.regularMaterial` 背景
- 平滑动画（0.25 秒）
- 基于状态的径向渐变叠加
- 动态阴影

---

### 3. 搜索栏 (SearchBarView)

**文件位置：** `Views/MainWindow/SearchBarView.swift`

**设计：**
```
┌────────────────────────────────────┐
│ 🔍 搜索...                    ✕   │
└────────────────────────────────────┘
```

**特性：**
- 放大镜图标
- 清除按钮（输入文本时显示）
- 材质背景 + 悬停效果
- 8pt 圆角

**悬停动画（第 45-48 行）：**
- 阴影从 2pt 增加到 4pt
- 不透明度从 0.06 增加到 0.12
- 0.2 秒平滑过渡

---

### 4. 设置视图 (SettingsView)

**文件位置：** `Views/Settings/SettingsView.swift`

**标签页/分组（第 11-23 行）：**
```swift
enum SettingsGroup {
    case general   // "通用" - 齿轮图标
    case storage   // "存储" - 硬盘图标
    case privacy   // "隐私" - 盾牌图标（占位）
}
```

**通用设置（第 116-191 行）：**
1. **启用剪贴板历史** - 新增主开关，默认关闭，首次在设置中开启时会弹出确认弹窗，提醒数据仅存本机沙盒且可随时停用
2. **通知开关** - 启用/禁用剪贴板通知
3. **音效开关** - 启用/禁用音效（启用时播放示例）
4. **全局快捷键** - ShortcutRecorderView 用于自定义
5. **开机启动** - macOS 13+ 使用 `SMAppService.mainApp` 控制；旧系统默认禁用，需要手动启动

**存储设置（第 195-232 行）：**
1. **历史记录上限** - 分段选择器：50 / 200 / 永久（999）
2. **忽略大图片** - 开关，跳过 >20MB 的图片

**隐私设置（第 235-253 行）：**
- 顶部说明默认忽略密码管理器与敏感剪贴板类型，用户可在「忽略应用」「忽略类型」子页中自定义
- 忽略类型子页新增总开关（默认开启）以及可编辑列表
- 退出时清空历史的开关仍位于该分组底部

**UI 布局：**
- 420×500 窗口尺寸
- 带图标的标签选择器
- 可滚动内容区域
- Glass 卡片组件（`SettingsSectionView`）
- 底部 "完成" 按钮

---

### 5. 引导流程 (OnboardingView)

**文件位置：** `Views/Onboarding/OnboardingView.swift`

**3 步向导：**

**步骤 1：通知权限（第 46-62 行）**
- 图标：🔔 bell.fill（蓝色）
- 标题："开启通知"
- 描述："接收剪贴板复制和粘贴提醒"
- 主要操作："授予权限" → `requestNotificationPermission()`
- 授权后自动进入步骤 2

**步骤 2：辅助功能权限（第 64-79 行）**
- 图标：☝️ hand.point.up.left.fill（绿色）
- 标题："开启辅助功能"
- 描述："允许 PasteMine 实现自动粘贴功能"
- 主要操作："打开系统设置" → 打开隐私_辅助功能面板
- 轮询：每 1 秒检查一次权限（第 134-158 行）
- 授权后自动进入步骤 3

**步骤 3：完成（第 81-88 行）**
- 显示已授予权限的摘要
- 新增“启用剪贴板历史记录”开关，默认关闭，勾选后才会在本机 Application Support 沙盒目录中保存最近 50 条记录
- 提供“查看隐私政策”链接，阐明数据仅保存在本地，可随时在设置中停用或清空
- 缺少权限时显示警告图标
- "开始使用" 按钮 → 设置 `hasCompletedOnboarding` 标志，并根据勾选状态写入 `clipboardHistoryEnabled`

**窗口规格（AppDelegate 第 140-145 行）：**
- 尺寸：500×480
- 样式：有标题栏、可关闭、全尺寸内容
- 层级：浮动
- 居中显示

---

## 特色功能

### 1. 固定/取消固定功能

**提交记录：**
- `0f9debf` - 添加固定/取消固定功能
- `71c4abb` - 改进固定图标和视觉样式

**实现细节：**

1. **数据模型**（`ClipboardItem.swift`）
   - `isPinned: Bool` - 固定状态
   - `pinnedAt: Date?` - 固定时间戳

2. **UI 指示器**（`HistoryItemView.swift`）
   - 已固定项目显示蓝色边框（1.5pt，30% 不透明度）
   - 固定按钮（📌）在已固定时始终可见
   - 未固定项目悬停时显示固定按钮

3. **排序逻辑**（`HistoryListView.swift`，第 50-63 行）
   - 已固定项目显示在最前面
   - 已固定项目内：按 `pinnedAt` 降序排列
   - 未固定项目内：按 `createdAt` 降序排列

4. **右键菜单**
   - 右键点击任何项目
   - "固定" / "取消固定" 选项

---

### 2. 大图片处理

**提交记录：** `d4862c1` - 用忽略大图片开关替换图片大小选择器

**功能详情：**
- **设置项：** "忽略大图片以节省磁盘空间"
- **阈值：** 20 MB
- **行为：** 启用时拒绝 >20MB 的图片
- **错误处理：** 抛出带描述性消息的 NSError

**代码位置：**
- 设置：`AppSettings.ignoreLargeImages`（`Models/Settings.swift` 第 16 行）
- 阈值：`AppSettings.largeImageThreshold = 20`（第 44 行）
- 检查：`ImageStorageManager.saveImageRawData()`（第 36-42 行）

---

### 3. Liquid Glass 设计

**设计理念：**
- macOS 14+ 材质效果
- 平滑动画（0.2-0.25 秒）
- 通过阴影和渐变创造深度感
- 悬停状态增强交互性

**实现（`ColorExtensions.swift`）：**
```swift
static let glassTransition = Animation.smooth(duration: 0.25)
static let hoverTransition = Animation.smooth(duration: 0.2)
```

**应用场景：**
- `HistoryItemView` - 材质背景 + 径向渐变
- `SearchBarView` - 悬停阴影效果
- `SettingsView` - Glass 卡片组件
- 主窗口 - `.ultraThinMaterial` 背景

---

### 4. 键盘导航

**支持的操作（在 `HistoryListView` 中）：**
- **↓ 下方向键：** 选择下一个项目
- **↑ 上方向键：** 选择上一个项目
- **回车键：** 粘贴选中的项目
- **自动滚动：** 选中项目滚动到中心位置

**实现（第 145-174 行）：**
- 自定义 `KeyboardEventView`（NSViewRepresentable）
- `KeyEventHandlingView` 捕获 `keyDown` 事件
- 滚动动画：`.easeOut(duration: 0.2)`

---

## 数据流程图

### 剪贴板复制流程

```
用户复制文本/图片
        ↓
NSPasteboard.changeCount 发生变化
        ↓
ClipboardMonitor.checkClipboard()（0.5 秒轮询）
        ↓
    [文本]              [图片]
        ↓                   ↓
handleText()        handleImage()
        ↓                   ↓
SHA-256 哈希        SHA-256 哈希
        ↓                   ↓
检查 hashExists()   检查 hashExists()
        ↓                   ↓
DatabaseService     ImageStorageManager
.insertTextItem()   .saveImageRawData()
        ↓                   ↓
        └─────── Core Data ──────┘
                    ↓
        NotificationService.sendClipboardNotification()
                    ↓
            SoundService.playCopySound()
```

### 粘贴流程

```
用户打开窗口（⌘⇧V）
        ↓
HistoryListView 显示项目
        ↓
用户选择项目（点击/回车）
        ↓
PasteService.paste(item)
        ↓
clipboardMonitor.isPasting = true（防止重复保存）
        ↓
NSPasteboard.clearContents()
        ↓
    [文本]                      [图片]
        ↓                           ↓
setString(_)              setData(rawData, type)
        ↓                           ↓
        └────── WindowManager.hide() ───────┘
                        ↓
        previousApp.activate()（延迟 0.15 秒）
                        ↓
        simulatePaste()（通过 CGEvent 模拟 Cmd+V）（延迟 0.1 秒）
                        ↓
        NotificationService.sendPasteNotification()
                        ↓
        SoundService.playPasteSound()
                        ↓
        clipboardMonitor.isPasting = false（延迟 0.6 秒）
```

### 设置更新流程

```
用户在 SettingsView 更改设置
        ↓
    @State 变量更新
        ↓
    .onChange() 修饰符触发
        ↓
    AppSettings.save()（编码到 UserDefaults）
        ↓
        ┌────────────────┬──────────────┬─────────────┬──────────────┐
        ↓                ↓              ↓             ↓              ↓
[globalShortcut]  [launchAtLogin]  [soundEnabled]  [maxHistoryCount]
        ↓                ↓              ↓             ↓
NotificationCenter  LaunchAtLoginService  测试音效   DatabaseService
.shortcutDidChange  .setLaunchAtLogin()   播放        .trimToLimit()
        ↓
HotKeyManager
.shortcutSettingsDidChange()
        ↓
注销旧快捷键 + 注册新快捷键
```

---

## 系统权限与配置

### Info.plist 配置

**关键设置：**
```xml
<key>LSUIElement</key>
<true/>                              <!-- 菜单栏应用（无 Dock 图标） -->

<key>NSUserNotificationUsageDescription</key>
<string>需要通知权限来提醒您复制和粘贴内容</string>

<key>NSAppleEventsUsageDescription</key>
<string>当您从历史记录中主动选择条目后，PasteMine 会向前台应用发送一次 Cmd+V Apple Event 以完成自动粘贴。</string>
```

### Entitlements 配置

```xml
<key>com.apple.security.app-sandbox</key>
<true/>                              <!-- Mac App Store 必须启用 -->

<key>com.apple.security.automation.apple-events</key>
<true/>                              <!-- 向前台应用发送 Cmd+V -->

<key>com.apple.security.files.user-selected.read-only</key>
<true/>                              <!-- 允许用户选择图片导出位置 -->
```

### Privacy Manifest (PrivacyInfo.xcprivacy)

- **文件位置：** `PasteMine/PrivacyInfo.xcprivacy`
- **收集数据声明：**
  - `NSPrivacyCollectedDataTypeUserContent`（剪贴板文字与图片，仅在本地存储并用于核心功能）
  - `NSPrivacyCollectedDataTypeUsageDataProductInteraction`（界面操作统计，仅用于改善体验）
- **受限制 API：**
  - `NSPrivacyAccessedAPICategoryPasteboard`，理由 `C617.1`（用户主动选择历史记录后读取粘贴板）
  - `NSPrivacyAccessedAPICategoryAppleEvents`，理由 `7B41.1`（在用户选择自动粘贴时向前台应用发送 Cmd+V Apple Event）
- Manifest 声明需与 App Store Connect 的 App Privacy 问卷保持一致，审核备注中也需强调相同用途与范围。

### 必需权限

1. **通知授权：**
   - 在 `NotificationService.requestPermission()` 中请求
   - 在引导流程中首次设置
   - 可选但建议启用

2. **辅助功能权限：**
   - `CGEvent` 键盘模拟所需
   - 自动粘贴功能必需
   - 在 `Extensions.swift` 第 13 行检查
   - 在引导流程步骤 2 中提示

---

## 性能优化

### 1. 剪贴板监控效率
- **轮询间隔：** 0.5 秒（而非 0.1 秒）以降低 CPU 使用
- **提前退出：** 处理前检查 `changeCount`
- **哈希比较：** 防止重复处理

### 2. 图片存储
- **基于哈希的文件名：** O(1) 去重
- **无数据库 BLOB：** 减小 Core Data 大小
- **孤立文件清理：** 提供 `cleanOrphanedImages()` 方法

### 3. 数据库优化
- **自动合并：** `automaticallyMergesChangesFromParent`
- **获取请求限制：** 按日期降序排序，受设置限制
- **后台删除：** `clearAll()` 在 `.userInitiated` 队列上运行

### 4. UI 响应性
- **懒加载：** SwiftUI List 配合 `@FetchRequest`
- **滚动虚拟化：** 仅渲染可见项目
- **异步动画：** 删除使用 `.easeOut(duration: 0.15)`

---

## 最近开发历史

**最新 10 次提交：**
```
d4862c1 - 用忽略大图片开关替换图片大小选择器
71c4abb - 改进固定图标和已固定项目视觉样式
0f9debf - 为剪贴板项目添加固定/取消固定功能
af168d7 - 修复通知音效冲突并调整引导窗口大小
d9942e6 - 修复引导流程编译错误
d86f906 - 为首次设置添加引导流程
89088ef - 改进通知权限请求流程
65aecaa - 从设置中移除保留时间功能
03ed667 - 更新 .gitignore 以排除构建产物
e3bf02f - 将历史记录上限选项更新为 50/200/永久
```

**主要功能新增：**
1. 固定/取消固定剪贴板项目（视觉指示器、排序）
2. 大图片过滤（20MB 阈值开关）
3. 引导向导（权限设置）
4. 音效反馈（复制/粘贴）

---

## 架构亮点

### 优势

1. **清晰的关注点分离：**
   - 服务层（剪贴板、数据库、粘贴、通知）
   - 管理器层（窗口、快捷键）
   - 模型层（数据结构）
   - 视图层（UI 组件）

2. **健壮的去重机制：**
   - SHA-256 哈希防止重复条目
   - 基于哈希的图片文件名实现文件复用

3. **权限意识设计：**
   - 使用 Carbon API 处理快捷键（无需输入监控权限）
   - 缺少权限时的优雅降级
   - 教育性引导流程

4. **性能导向：**
   - 轮询间隔平衡了响应性与 CPU 占用
   - 大型操作的后台删除
   - 图片文件外部存储（不在 Core Data 中）

5. **用户体验：**
   - 智能窗口定位（跟随光标）
   - 键盘导航
   - 固定收藏项目
   - Material 设计美学

### 潜在改进方向

1. **剪贴板监控：**
   - 可使用 `NSPasteboard.general.changeCount` 观察器代替轮询
   - 备选方案：剪贴板变化的分布式通知

2. **图片格式支持：**
   - 当前：PNG、TIFF、PDF
   - 可添加：JPEG、GIF、HEIC

3. **搜索功能：**
   - 当前：简单子串匹配
   - 可添加：正则表达式、标签、高级过滤

4. **隐私标签页：**
   - 当前为占位符
   - 可添加：排除应用、敏感数据过滤、加密

5. **同步功能：**
   - 当前仅本地
   - 可添加：iCloud 同步、导出/导入

---

## 技术栈总结

- **框架：** SwiftUI、Core Data、AVFoundation、Carbon Event Manager
- **语言：** Swift
- **最低系统要求：** macOS 13+（部分功能需要 macOS 14+）
- **设计风格：** Liquid Glass（材质效果、平滑动画）
- **存储：** Core Data + 文件系统（图片）
- **安全性：** SHA-256 哈希、沙盒配置、权限管理

---

## 结论

PasteMine 是一个架构良好的 macOS 剪贴板管理器，具有现代化的 SwiftUI 设计、健壮的数据管理和周到的用户体验功能。代码库展示了：

- **坚实的基础：** Core Data 持久化、基于文件的图片存储、基于哈希的去重
- **现代技术：** SwiftUI、Combine（通过 `@FetchRequest`）、CryptoKit
- **以用户为中心的功能：** 固定/取消固定、键盘导航、智能定位、引导流程
- **性能意识：** 后台操作、懒加载、高效轮询

该项目处于活跃维护状态（最近提交），遵循 macOS 菜单栏工具的最佳实践，是专业级剪贴板历史应用的优秀范例。

---

## App Store 审核备注要点

1. **自动粘贴触发条件**：仅在用户通过菜单栏或快捷键调出窗口，并从历史列表中主动选择条目时才会复制并（在授权情况下）模拟 Cmd+V。
2. **权限透明度**：Onboarding 第 2、3 步以及设置-通用页均提示辅助功能用途及降级行为；若未授权，会显示窗口内 Banner 与系统通知提醒。
3. **数据存储范围**：所有剪贴板历史仅保存在 `~/Library/Containers/com.lemonstyle.PasteMine/Data/Library/Application Support/PasteMine/`，不会上传或分享，可随时停用或清空。
4. **隐私过滤默认开启**：初始即忽略常见密码管理器应用和敏感 Pasteboard Type，避免意外记录机密信息。
5. **Privacy Manifest 对齐**：App 内 manifest 与 App Store Connect 问卷使用一致的 API 理由（C617.1、7B41.1）和数据类别描述。

将以上要点附在 App Review Notes 并配合权限截图，可显著缩短审核沟通时间。

---

**文档版本：** 1.0
**最后更新：** 2025-12-01
**项目状态：** 活跃开发中
